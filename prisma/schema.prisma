// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model OrganizationType {
  id            String         @id @unique @default(uuid()) @db.Uuid
  name          String         @map("name") @db.VarChar(255)
  description   String?        @map("description") @db.Text
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt     DateTime?      @map("deleted_at") @db.Timestamptz()
  organizations Organization[] @relation("OrganizationType")

  @@map("organization_types")
}

model Department {
  id        String                @id @unique @default(uuid()) @db.Uuid
  name      String                @map("name") @db.VarChar(255)
  createdAt DateTime              @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime              @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime?             @map("deleted_at") @db.Timestamptz()
  managers  OrganizationManager[] @relation("DepartmentManager")

  @@map("departments")
}

model Role {
  id        String    @id @unique @default(uuid()) @db.Uuid
  name      String    @map("name") @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()
  accounts  Account[] @relation("AccountRole")

  @@map("roles")
}

model VerificationCodes {
  id        String    @id @unique @default(uuid()) @db.Uuid
  code      String    @map("code") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz()
  accountId String    @map("account_id") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  account Account @relation(name: "AccountVerification", fields: [accountId], references: [id])

  @@map("verification_codes")
}

enum OrganizationStatus {
  PENDING
  ACCEPTED
  REJECTED
  INFO_REQUESTED
}

model Organization {
  id                     String             @id @unique @default(uuid()) @db.Uuid
  typeId                 String             @map("type_id") @db.Uuid
  addressId              String             @map("address_id") @db.Uuid
  address                Address            @relation("Address", fields: [addressId], references: [id])
  type                   OrganizationType   @relation(name: "OrganizationType", fields: [typeId], references: [id])
  name                   String             @map("name") @db.VarChar(255)
  website                String?            @map("website") @db.VarChar(255)
  isAuthorized           Boolean            @default(false) @map("is_authorized")
  dataSharingConsent     Boolean            @default(false) @map("data_sharing_consent")
  agreeToTermsAndPrivacy Boolean            @default(false) @map("agree_to_terms_and_privacy")
  status                 OrganizationStatus @default(PENDING) @map("status")
  approvedBy             String?            @map("approved_by") @db.Uuid
  approvedAt             DateTime?          @map("approved_at") @db.Timestamptz()
  rejectedBy             String?            @map("rejected_by") @db.Uuid
  rejectedAt             DateTime?          @map("rejected_at") @db.Timestamptz()
  rejectedReason         String?            @map("rejected_reason") @db.Text

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  manager OrganizationManager[] @relation("OrganizationManager")
  cases   Case[]                @relation("OrganizationCases")

  @@map("organizations")
}

model OrganizationManager {
  id             String    @id @unique @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  accountId      String    @map("account_id") @db.Uuid
  jobTitle       String?   @map("job_title") @db.VarChar(255)
  departmentId   String?   @map("department_id") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz()

  account      Account      @relation(name: "AccountManager", fields: [accountId], references: [id])
  organization Organization @relation(name: "OrganizationManager", fields: [organizationId], references: [id])
  department   Department?  @relation(name: "DepartmentManager", fields: [departmentId], references: [id])

  @@map("organization_managers")
}

model User {
  id             String    @id @unique @default(uuid()) @db.Uuid
  firstName      String    @map("first_name") @db.VarChar(255)
  lastName       String    @map("last_name") @db.VarChar(255)
  email          String    @unique @map("email") @db.VarChar(255)
  password       String?   @map("password") @db.VarChar(255)
  phone          String?   @map("phone") @db.VarChar(255)
  gender         String?   @map("gender") @db.VarChar(255)
  dateOfBirth    DateTime? @map("date_of_birth") @db.Timestamptz()
  profilePhotoId String?   @map("profile_photo_id") @db.Uuid

  profilePhoto Documents? @relation(name: "ProfilePhoto", fields: [profilePhotoId], references: [id])

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()
  accounts  Account[] @relation("AccountUser")

  @@map("users")
}

model Account {
  id         String    @id @unique @default(uuid()) @db.Uuid
  roleId     String    @map("role_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  isVerified Boolean   @default(false) @map("is_verified")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz()

  role                 Role                  @relation(name: "AccountRole", fields: [roleId], references: [id])
  user                 User                  @relation(name: "AccountUser", fields: [userId], references: [id])
  verificationCodes    VerificationCodes[]   @relation("AccountVerification")
  managers             OrganizationManager[] @relation("AccountManager")
  examinations         Examination[]         @relation("ExaminerCases")
  assignedExaminations Examination[]         @relation("AssignedCases")
  examinerProfiles     ExaminerProfile[]

  @@map("accounts")
}

model Address {
  id         String  @id @unique @default(uuid()) @db.Uuid
  address    String  @map("address") @db.Text
  street     String? @map("street") @db.VarChar(255)
  province   String? @map("province") @db.VarChar(255)
  city       String? @map("city") @db.VarChar(255)
  postalCode String? @map("postal_code") @db.VarChar(255)
  suite      String? @map("suite") @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  organizations        Organization[]         @relation("Address")
  claimants            Claimant[]             @relation("ClaimantAddress")
  examinationTransport ExaminationTransport[] @relation("ExaminationTransport")
  legalRepresentatives LegalRepresentative[]  @relation("LegalRepresentativeAddress")
  insurances           Insurance[]            @relation("InsuranceAddress")

  @@map("addresses")
}

model Claimant {
  id                       String    @id @unique @default(uuid()) @db.Uuid
  firstName                String    @map("first_name") @db.VarChar(255)
  lastName                 String    @map("last_name") @db.VarChar(255)
  dateOfBirth              DateTime? @map("date_of_birth") @db.Date
  gender                   String?   @map("gender") @db.VarChar(50)
  phoneNumber              String?   @map("phone_number") @db.VarChar(255)
  emailAddress             String?   @map("email_address") @db.VarChar(255)
  relatedCasesDetails      String?   @map("related_cases_details") @db.Text
  familyDoctorName         String?   @map("family_doctor_name") @db.VarChar(255)
  familyDoctorEmailAddress String?   @map("family_doctor_email_address") @db.VarChar(255)
  familyDoctorPhoneNumber  String?   @map("family_doctor_phone_number") @db.VarChar(255)
  familyDoctorFaxNumber    String?   @map("family_doctor_fax_number") @db.VarChar(255)
  addressId                String    @map("address_id") @db.Uuid
  claimTypeId              String    @map("claim_type_id") @db.Uuid
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt                DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt                DateTime? @map("deleted_at") @db.Timestamptz()

  address          Address           @relation("ClaimantAddress", fields: [addressId], references: [id])
  examinations     Examination[]     @relation("ExaminationClaimant")
  claimantBookings ClaimantBooking[] @relation("ClaimantBooking")
  claimType        ClaimType         @relation("ClaimantClaimType", fields: [claimTypeId], references: [id])

  @@map("claimants")
}

model LegalRepresentative {
  id                String   @id @unique @default(uuid()) @db.Uuid
  companyName       String?  @map("company_name") @db.VarChar(255)
  contactPersonName String?  @map("contact_person") @db.VarChar(255)
  phoneNumber       String?  @map("phone_number") @db.VarChar(255)
  faxNumber         String?  @map("fax_number") @db.VarChar(255)
  addressId         String?  @map("address_id") @db.Uuid
  address           Address? @relation("LegalRepresentativeAddress", fields: [addressId], references: [id])

  examinations Examination[] @relation("ExaminationLegalRepresentative")

  @@map("legal_representatives")
}

model Insurance {
  id                     String   @id @unique @default(uuid()) @db.Uuid
  emailAddress           String   @map("email_address") @db.VarChar(255)
  companyName            String   @map("company_name") @db.VarChar(255)
  contactPersonName      String   @map("contact_person") @db.VarChar(255)
  policyNumber           String   @map("policy_number") @db.VarChar(255)
  claimNumber            String   @map("claim_number") @db.VarChar(255)
  dateOfLoss             DateTime @map("date_of_loss") @db.Timestamptz()
  policyHolderIsClaimant Boolean  @default(false) @map("policy_holder_is_claimant")
  policyHolderFirstName  String   @map("policy_holder_first_name") @db.VarChar(255)
  policyHolderLastName   String   @map("policy_holder_last_name") @db.VarChar(255)
  phoneNumber            String   @map("phone_number") @db.VarChar(255)
  faxNumber              String   @map("fax_number") @db.VarChar(255)
  addressId              String?  @map("address_id") @db.Uuid
  address                Address? @relation("InsuranceAddress", fields: [addressId], references: [id])

  examinations Examination[] @relation("ExaminationInsurance")

  @@map("insurances")
}

model Case {
  id                   String  @id @unique @default(uuid()) @db.Uuid
  organizationId       String? @map("organization_id") @db.Uuid
  caseTypeId           String? @map("case_type_id") @db.Uuid
  reason               String? @map("reason") @db.VarChar(255)
  consentForSubmission Boolean @default(false) @map("consent_for_submission")
  isDraft              Boolean @default(false) @map("is_draft")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  organization Organization?  @relation("OrganizationCases", fields: [organizationId], references: [id])
  caseType     CaseType?      @relation("CaseTypeCases", fields: [caseTypeId], references: [id])
  examinations Examination[]  @relation("ExaminationCases")
  documents    CaseDocument[] @relation("CaseDocuments")

  @@map("cases")
}

enum UrgencyLevel {
  HIGH
  MEDIUM
  LOW
}

model Examination {
  id                String             @id @unique @default(uuid()) @db.Uuid
  caseNumber        String             @map("case_number") @db.VarChar(255)
  caseId            String             @map("case_id") @db.Uuid
  examinationTypeId String             @map("examination_type_id") @db.Uuid
  dueDate           DateTime?          @map("due_date") @db.Timestamptz()
  notes             String?            @map("notes") @db.Text
  additionalNotes   String?            @map("additional_notes") @db.Text
  urgencyLevel      UrgencyLevel?      @map("urgency_level")
  examinerId        String?            @map("examiner_id") @db.Uuid
  statusId          String             @map("status_id") @db.Uuid
  preference        ClaimantPreference @map("preference")
  supportPerson     Boolean            @default(false) @map("support_person")

  assignToId String?   @map("assign_to_id") @db.Uuid
  assignedAt DateTime? @map("assigned_at") @db.Timestamptz()
  approvedAt DateTime? @map("approved_at") @db.Timestamptz()

  claimantId            String  @map("claimant_id") @db.Uuid
  insuranceId           String? @map("insurance_id") @db.Uuid
  legalRepresentativeId String? @map("legal_representative_id") @db.Uuid

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  case             Case                         @relation("ExaminationCases", fields: [caseId], references: [id])
  examinationType  ExaminationType              @relation("ExaminationType", fields: [examinationTypeId], references: [id])
  examiner         Account?                     @relation("ExaminerCases", fields: [examinerId], references: [id])
  status           CaseStatus                   @relation("CaseStatus", fields: [statusId], references: [id])
  assignTo         Account?                     @relation("AssignedCases", fields: [assignToId], references: [id])
  secureLinks      ExaminationSecureLink[]      @relation("ExaminationSecureLink")
  claimantBookings ClaimantBooking[]            @relation("ExaminationClaimantBooking")
  services         ExaminationServices[]        @relation("ExaminationServices")
  selectedBenefits ExaminationSelectedBenefit[] @relation("ExaminationSelectedBenefits")

  claimant            Claimant             @relation("ExaminationClaimant", fields: [claimantId], references: [id])
  insurance           Insurance?           @relation("ExaminationInsurance", fields: [insuranceId], references: [id])
  legalRepresentative LegalRepresentative? @relation("ExaminationLegalRepresentative", fields: [legalRepresentativeId], references: [id])

  @@index([caseId])
  @@index([caseNumber])
  @@map("examinations")
}

enum ExaminationSecureLinkStatus {
  PENDING
  SUBMITTED
  INVALID
}

model ExaminationSecureLink {
  id            String                      @id @unique @default(uuid()) @db.Uuid
  examinationId String                      @map("examination_id") @db.Uuid
  token         String                      @map("token") @db.VarChar(255)
  expiresAt     DateTime                    @map("expires_at") @db.Timestamptz()
  lastOpenedAt  DateTime?                   @map("last_opened_at") @db.Timestamptz()
  submittedAt   DateTime?                   @map("submitted_at") @db.Timestamptz()
  status        ExaminationSecureLinkStatus @default(PENDING) @map("status")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  examination Examination @relation("ExaminationSecureLink", fields: [examinationId], references: [id])

  @@map("examination_secure_links")
}

enum ClaimantPreference {
  IN_PERSON
  VIRTUAL
  EITHER
}

enum ClaimantBookingStatus {
  PENDING
  ACCEPT
  DECLINE
  REQUEST_MORE_INFO
  DISCARDED
}

model ClaimantBooking {
  id                 String                 @id @unique @default(uuid()) @db.Uuid
  examinationId      String                 @map("examination_id") @db.Uuid
  claimantId         String                 @map("claimant_id") @db.Uuid
  examinerProfileId  String                 @map("examiner_profile_id") @db.Uuid
  bookingTime        DateTime               @map("booking_time") @db.Timestamptz()
  preference         ClaimantPreference     @map("preference")
  accessibilityNotes String?                @map("accessibility_notes") @db.Text
  consentAck         Boolean                @default(false) @map("consent_ack")
  status             ClaimantBookingStatus? @map("status")

  // Optional service provider IDs
  interpreterId String? @map("interpreter_id") @db.Uuid
  chaperoneId   String? @map("chaperone_id") @db.Uuid
  transporterId String? @map("transporter_id") @db.Uuid

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  examination Examination     @relation("ExaminationClaimantBooking", fields: [examinationId], references: [id])
  claimant    Claimant        @relation("ClaimantBooking", fields: [claimantId], references: [id])
  examiner    ExaminerProfile @relation("ClaimantBookingExaminer", fields: [examinerProfileId], references: [id])
  interpreter Interpreter?    @relation("ClaimantBookingInterpreter", fields: [interpreterId], references: [id])
  chaperone   Chaperone?      @relation("ClaimantBookingChaperone", fields: [chaperoneId], references: [id])
  transporter Transporter?    @relation("ClaimantBookingTransporter", fields: [transporterId], references: [id])

  @@unique([examinationId, claimantId]) // One booking per examination per claimant
  @@index([examinationId])
  @@index([examinerProfileId])
  @@index([bookingTime])
  @@index([status])
  @@map("claimant_bookings")
}

model ExaminationServices {
  id            String  @id @unique @default(uuid()) @db.Uuid
  examinationId String  @map("examination_id") @db.Uuid
  type          String  @map("type") @db.VarChar(255)
  enabled       Boolean @default(false) @map("enabled")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  examination Examination             @relation("ExaminationServices", fields: [examinationId], references: [id])
  interpreter ExaminationInterpreter? @relation("ExaminationInterpreter")
  transport   ExaminationTransport?   @relation("ExaminationTransport")

  @@map("examination_services")
}

model ExaminationInterpreter {
  id                   String @id @unique @default(uuid()) @db.Uuid
  examinationServiceId String @unique @map("examination_service_id") @db.Uuid
  languageId           String @map("language_id") @db.Uuid

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  examinationService ExaminationServices @relation("ExaminationInterpreter", fields: [examinationServiceId], references: [id])
  language           Language            @relation("ExaminationInterpreter", fields: [languageId], references: [id])

  @@map("examination_interpreter")
}

model Language {
  id        String    @id @unique @default(uuid()) @db.Uuid
  name      String    @map("name") @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  examinationInterpreter ExaminationInterpreter[] @relation("ExaminationInterpreter")
  examinerLanguages      ExaminerLanguage[]
  interpreterLanguages   InterpreterLanguage[]

  @@map("languages")
}

model ExaminationTransport {
  id                   String  @id @unique @default(uuid()) @db.Uuid
  examinationServiceId String  @unique @map("examination_service_id") @db.Uuid
  pickupAddressId      String? @map("pickup_address_id") @db.Uuid
  rawLookup            String? @map("raw_lookup") @db.Text
  notes                String? @map("notes") @db.Text

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  examinationService ExaminationServices @relation("ExaminationTransport", fields: [examinationServiceId], references: [id])
  pickupAddress      Address?            @relation("ExaminationTransport", fields: [pickupAddressId], references: [id])

  @@map("examination_transport")
}

model CaseDocument {
  id         String    @id @unique @default(uuid()) @db.Uuid
  caseId     String    @map("case_id") @db.Uuid
  documentId String    @map("document_id") @db.Uuid
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt  DateTime? @map("deleted_at") @db.Timestamptz()

  case     Case      @relation("CaseDocuments", fields: [caseId], references: [id])
  document Documents @relation("DocumentCases", fields: [documentId], references: [id])

  @@unique([caseId, documentId])
  @@map("case_documents")
}

model Documents {
  id                String            @id @unique @default(uuid()) @db.Uuid
  name              String            @map("name") @db.VarChar(255)
  displayName       String?           @map("display_name") @db.VarChar(255)
  type              String            @map("type") @db.VarChar(255)
  size              Int               @map("size") @db.Integer
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime          @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt         DateTime?         @map("deleted_at") @db.Timestamptz()
  users             User[]            @relation("ProfilePhoto")
  cases             CaseDocument[]    @relation("DocumentCases")
  medicalLicenses   ExaminerProfile[] @relation(name: "ExaminerMedicalLicenseDocument")
  examinerResume    ExaminerProfile[] @relation(name: "ExaminerResumeDocument")
  examinerNDA       ExaminerProfile[] @relation(name: "ExaminerNDADocument")
  examinerInsurance ExaminerProfile[] @relation(name: "ExaminerInsuranceDocument")

  @@map("documents")
}

model ExaminationType {
  id           String                   @id @unique @default(uuid()) @db.Uuid
  name         String                   @unique @map("name") @db.VarChar(255)
  shortForm    String?                  @map("short_form") @db.VarChar(255)
  description  String?                  @map("description") @db.Text
  createdAt    DateTime                 @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt    DateTime                 @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt    DateTime?                @map("deleted_at") @db.Timestamptz()
  examinations Examination[]            @relation("ExaminationType")
  benefits     ExaminationTypeBenefit[] @relation("ExaminationTypeBenefits")

  @@map("examination_types")
}

model ExaminationTypeBenefit {
  id                String    @id @unique @default(uuid()) @db.Uuid
  examinationTypeId String    @map("examination_type_id") @db.Uuid
  benefit           String    @map("benefit") @db.VarChar(500)
  description       String?   @map("description") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz()

  examinationType ExaminationType              @relation("ExaminationTypeBenefits", fields: [examinationTypeId], references: [id], onDelete: Cascade)
  selectedByExams ExaminationSelectedBenefit[] @relation("SelectedBenefits")

  @@index([examinationTypeId])
  @@map("examination_type_benefits")
}

model ExaminationSelectedBenefit {
  id            String    @id @unique @default(uuid()) @db.Uuid
  examinationId String    @map("examination_id") @db.Uuid
  benefitId     String    @map("benefit_id") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz()

  examination Examination            @relation("ExaminationSelectedBenefits", fields: [examinationId], references: [id], onDelete: Cascade)
  benefit     ExaminationTypeBenefit @relation("SelectedBenefits", fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([examinationId, benefitId])
  @@index([examinationId])
  @@index([benefitId])
  @@map("examination_selected_benefits")
}

model CaseType {
  id          String    @id @unique @default(uuid()) @db.Uuid
  name        String    @map("name") @db.VarChar(255)
  description String?   @map("description") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz()
  cases       Case[]    @relation("CaseTypeCases")

  @@map("case_types")
}

model MaximumDistanceTravel {
  id          String    @id @unique @default(uuid()) @db.Uuid
  name        String    @map("name") @db.VarChar(255)
  description String?   @map("description") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz()

  @@map("maximum_distance_travel")
}

model YearsOfExperience {
  id          String    @id @unique @default(uuid()) @db.Uuid
  name        String    @map("name") @db.VarChar(255)
  description String?   @map("description") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz()

  @@map("years_of_experience")
}

model ClaimType {
  id          String    @id @unique @default(uuid()) @db.Uuid
  name        String    @map("name") @db.VarChar(255)
  description String?   @map("description") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz()

  claimants Claimant[] @relation("ClaimantClaimType")

  @@map("claim_types")
}

model PrismaSeed {
  id        String    @id @unique @default(uuid()) @db.Uuid
  name      String    @map("name") @db.VarChar(255)
  runAt     DateTime  @map("run_at") @db.Timestamptz()
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  @@map("_prisma_seeds")
}

model CaseStatus {
  id          String    @id @unique @default(uuid()) @db.Uuid
  name        String    @map("name") @db.VarChar(255)
  description String?   @map("description") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz()

  examinations Examination[] @relation("CaseStatus")

  @@map("case_statuses")
}

enum ExaminerStatus {
  PENDING
  ACCEPTED
  REJECTED
  INFO_REQUESTED
  ACTIVE
}

model ExaminerLanguage {
  id                String   @id @default(uuid()) @db.Uuid
  examinerProfileId String   @map("examiner_profile_id") @db.Uuid
  languageId        String   @map("language_id") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  examinerProfile ExaminerProfile @relation(fields: [examinerProfileId], references: [id], onDelete: Cascade)
  language        Language        @relation(fields: [languageId], references: [id], onDelete: Restrict)

  @@unique([examinerProfileId, languageId])
  @@index([languageId])
  @@map("examiner_languages")
}

model ExaminerProfile {
  id                                String         @id @default(uuid()) @db.Uuid
  accountId                         String         @map("account_id") @db.Uuid
  provinceOfResidence               String         @map("province_of_residence") @db.VarChar(255)
  mailingAddress                    String         @map("mailing_address") @db.Text
  specialties                       String[]       @map("specialties")
  licenseNumber                     String         @map("license_number") @db.VarChar(255)
  landlineNumber                    String?        @map("landline_number") @db.VarChar(255)
  assessmentTypes                   String[]       @map("assessment_types")
  provinceOfLicensure               String         @map("province_of_licensure") @db.VarChar(255)
  licenseExpiryDate                 DateTime?      @map("license_expiry_date") @db.Date
  medicalLicenseDocumentId          String         @map("medical_license_document_id") @db.Uuid
  resumeDocumentId                  String         @map("resume_document_id") @db.Uuid
  NdaDocumentId                     String?        @map("nda_document_id") @db.Uuid
  insuranceDocumentId               String?        @map("insurance_document_id") @db.Uuid
  isForensicAssessmentTrained       Boolean        @map("is_forensic_assessment_trained")
  yearsOfIMEExperience              String         @map("years_of_ime_experience") @db.VarChar(255)
  bio                               String         @map("bio") @db.Text
  preferredRegions                  String?        @map("preferred_regions") @db.VarChar(255)
  maxTravelDistance                 String?        @map("max_travel_distance") @db.VarChar(255)
  acceptVirtualAssessments          Boolean?       @map("accept_virtual_assessments")
  bufferTime                        String?        @map("buffer_time") @db.VarChar(20)
  advanceBooking                    String?        @map("advance_booking") @db.VarChar(20)
  appointmentTypes                  String[]       @map("appointment_types")
  appointmentDuration               String?        @map("appointment_duration") @db.VarChar(20)
  minimumNoticeValue                String?        @map("minimum_notice_value") @db.VarChar(20)
  minimumNoticeUnit                 String?        @map("minimum_notice_unit") @db.VarChar(20)
  payoutMethod                      String?        @map("payout_method") @db.VarChar(20)
  transitNumber                     String?        @map("transit_number") @db.VarChar(5)
  institutionNumber                 String?        @map("institution_number") @db.VarChar(3)
  accountNumber                     String?        @map("account_number") @db.VarChar(12)
  chequeMailingAddress              String?        @map("cheque_mailing_address") @db.Text
  interacEmail                      String?        @map("interac_email") @db.VarChar(255)
  isConsentToBackgroundVerification Boolean        @map("is_consent_to_background_verification")
  agreeToTerms                      Boolean        @map("agree_to_terms")
  status                            ExaminerStatus @default(PENDING) @map("status")
  activationStep                    String?        @map("activation_step") @db.VarChar(255)
  approvedBy                        String?        @map("approved_by") @db.Uuid
  approvedAt                        DateTime?      @map("approved_at") @db.Timestamptz()
  rejectedBy                        String?        @map("rejected_by") @db.Uuid
  rejectedAt                        DateTime?      @map("rejected_at") @db.Timestamptz()
  rejectedReason                    String?        @map("rejected_reason") @db.Text
  createdAt                         DateTime       @default(now()) @db.Timestamptz()
  updatedAt                         DateTime       @updatedAt @db.Timestamptz()
  deletedAt                         DateTime?

  account                Account                @relation(fields: [accountId], references: [id], onDelete: Cascade)
  medicalLicenseDocument Documents              @relation(name: "ExaminerMedicalLicenseDocument", references: [id], fields: [medicalLicenseDocumentId])
  resumeDocument         Documents              @relation(name: "ExaminerResumeDocument", references: [id], fields: [resumeDocumentId])
  ndaDocument            Documents?             @relation(name: "ExaminerNDADocument", references: [id], fields: [NdaDocumentId])
  insuranceDocument      Documents?             @relation(name: "ExaminerInsuranceDocument", references: [id], fields: [insuranceDocumentId])
  feeStructure           ExaminerFeeStructure[] @relation("ExaminerFeeStructure")
  examinerLanguages      ExaminerLanguage[]
  claimantBookings       ClaimantBooking[]      @relation("ClaimantBookingExaminer")
  contracts              Contract[]             @relation("ExaminerContracts")
  // availabilityProvider - use AvailabilityProvider.findFirst({ where: { refId: id, providerType: 'EXAMINER' } })

  @@map("examiner_profiles")
}

model ExaminerFeeStructure {
  id                String    @id @default(uuid()) @db.Uuid
  examinerProfileId String    @map("examiner_profile_id") @db.Uuid
  IMEFee            Decimal?  @map("ime_fee") @db.Decimal(10, 2)
  recordReviewFee   Decimal   @map("record_review_fee") @db.Decimal(10, 2)
  hourlyRate        Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  cancellationFee   Decimal   @map("cancellation_fee") @db.Decimal(10, 2)
  paymentTerms      String    @map("payment_terms") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt         DateTime? @map("deleted_at") @db.Timestamptz()

  examinerProfile ExaminerProfile @relation("ExaminerFeeStructure", fields: [examinerProfileId], references: [id], onDelete: Cascade)

  @@index([examinerProfileId])
  @@map("examiner_fee_structure")
}

enum ProviderType {
  EXAMINER
  CHAPERONE
  INTERPRETER
  TRANSPORTER
}

model AvailabilityProvider {
  id String @id @default(uuid()) @db.Uuid

  /// What kind of resource this is (doctor, chaperone, interpreter, etc.)
  providerType ProviderType @map("provider_type")

  /// ID of the concrete row in its own table.
  /// - If providerType = EXAMINER  -> refId = ExaminerProfile.id
  /// - If providerType = CHAPERONE -> refId = Chaperone.id
  /// - If providerType = INTERPRETER -> refId = Interpreter.id
  /// - If providerType = TRANSPORTER -> refId = Transporter.id
  refId String @map("ref_id") @db.Uuid

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  // Availability relations
  weeklyHours   ProviderWeeklyHours[]   @relation("ProviderWeeklyHours")
  overrideHours ProviderOverrideHours[] @relation("ProviderOverrideHours")

  // Provider relations - polymorphic relationship
  // No foreign key constraints since refId can point to different tables based on providerType
  // Use application-level validation to ensure data integrity

  /// Prevents the same entity from being registered twice,
  /// even under a different type.
  @@unique([refId])
  @@map("availability_providers")
}

/// Day-of-week template availability lives here.
/// Each provider has at most 1 row per weekday.
enum Weekday {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

/// High-level "I work on Mondays, 09:00-12:00 and 14:00-17:00"
/// The individual windows go in ProviderWeeklyTimeSlot.
model ProviderWeeklyHours {
  id                     String @id @default(uuid()) @db.Uuid
  availabilityProviderId String @map("availability_provider_id") @db.Uuid

  dayOfWeek Weekday @map("day_of_week")
  enabled   Boolean @default(true) @map("enabled")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  provider  AvailabilityProvider     @relation("ProviderWeeklyHours", fields: [availabilityProviderId], references: [id], onDelete: Cascade)
  timeSlots ProviderWeeklyTimeSlot[]

  @@unique([availabilityProviderId, dayOfWeek])
  @@index([availabilityProviderId])
  @@map("provider_weekly_hours")
}

/// Multiple slots inside a weekday.
/// Example: 09:00-12:00, 14:00-17:00 on MONDAY.
model ProviderWeeklyTimeSlot {
  id           String @id @default(uuid()) @db.Uuid
  weeklyHourId String @map("weekly_hour_id") @db.Uuid

  /// Store as string like "09:00" / "14:30"
  /// We don't force timezone math here.
  startTime String @map("start_time") @db.VarChar(20)
  endTime   String @map("end_time") @db.VarChar(20)

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  weeklyHour ProviderWeeklyHours @relation(fields: [weeklyHourId], references: [id], onDelete: Cascade)

  @@index([weeklyHourId])
  @@map("provider_weekly_time_slots")
}

/// Date-specific override. "On 2025-11-03, here's my special schedule".
/// This replaces the weekday template for that date.
model ProviderOverrideHours {
  id                     String @id @default(uuid()) @db.Uuid
  availabilityProviderId String @map("availability_provider_id") @db.Uuid

  /// Which calendar day is overridden
  date DateTime @map("date") @db.Date

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  provider  AvailabilityProvider       @relation("ProviderOverrideHours", fields: [availabilityProviderId], references: [id], onDelete: Cascade)
  timeSlots ProviderOverrideTimeSlot[]

  /// 1 override record per provider per date.
  @@unique([availabilityProviderId, date])
  @@index([availabilityProviderId])
  @@index([date])
  @@map("provider_override_hours")
}

/// Multiple windows inside that override date.
model ProviderOverrideTimeSlot {
  id             String @id @default(uuid()) @db.Uuid
  overrideHourId String @map("override_hour_id") @db.Uuid

  /// Again "09:00", "13:30", etc.
  startTime String @map("start_time") @db.VarChar(20)
  endTime   String @map("end_time") @db.VarChar(20)

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  overrideHour ProviderOverrideHours @relation(fields: [overrideHourId], references: [id], onDelete: Cascade)

  @@index([overrideHourId])
  @@map("provider_override_time_slots")
}

model Chaperone {
  id        String  @id @unique @default(uuid()) @db.Uuid
  firstName String  @map("first_name") @db.VarChar(255)
  lastName  String  @map("last_name") @db.VarChar(255)
  email     String  @unique @map("email") @db.VarChar(255)
  phone     String? @map("phone") @db.VarChar(255)
  gender    String? @map("gender") @db.VarChar(255)

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz()

  claimantBookings ClaimantBooking[] @relation("ClaimantBookingChaperone")
  // availabilityProvider - use AvailabilityProvider.findFirst({ where: { refId: id, providerType: 'CHAPERONE' } })

  @@map("chaperones")
}

model Interpreter {
  id            String    @id @unique @default(uuid()) @db.Uuid
  companyName   String    @map("company_name") @db.VarChar(255)
  contactPerson String    @map("contact_person") @db.VarChar(255)
  email         String    @unique @map("email") @db.VarChar(255)
  phone         String?   @map("phone") @db.VarChar(255)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz()

  languages        InterpreterLanguage[] @relation("InterpreterLanguages")
  claimantBookings ClaimantBooking[]     @relation("ClaimantBookingInterpreter")
  // availabilityProvider - use AvailabilityProvider.findFirst({ where: { refId: id, providerType: 'INTERPRETER' } })

  @@map("interpreters")
}

model InterpreterLanguage {
  id            String   @id @unique @default(uuid()) @db.Uuid
  interpreterId String   @map("interpreter_id") @db.Uuid
  languageId    String   @map("language_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  interpreter Interpreter @relation("InterpreterLanguages", fields: [interpreterId], references: [id], onDelete: Cascade)
  language    Language    @relation(fields: [languageId], references: [id], onDelete: Restrict)

  @@unique([interpreterId, languageId])
  @@index([languageId])
  @@map("interpreter_languages")
}

enum TransporterStatus {
  SUSPENDED
  ACTIVE
}

model Transporter {
  id            String            @id @default(uuid()) @db.Uuid
  companyName   String            @map("company_name") @db.VarChar(255)
  contactPerson String            @map("contact_person") @db.VarChar(255)
  phone         String            @map("phone") @db.VarChar(20)
  email         String            @map("email") @db.VarChar(255)
  serviceAreas  Json              @map("service_areas") // Array of {province: string}
  status        TransporterStatus @default(ACTIVE) @map("status")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime          @updatedAt @map("updated_at") @db.Timestamptz()
  deletedAt     DateTime?         @map("deleted_at") @db.Timestamptz()

  claimantBookings ClaimantBooking[] @relation("ClaimantBookingTransporter")
  // availabilityProvider - use AvailabilityProvider.findFirst({ where: { refId: id, providerType: 'TRANSPORTER' } })

  @@map("transporters")
}

model DocumentTemplate {
  id               String   @id @default(uuid()) @db.Uuid
  slug             String   @unique @map("slug") @db.VarChar(255)
  displayName      String   @map("display_name") @db.VarChar(255)
  category         String   @map("category") @db.VarChar(100)
  currentVersionId String?  @unique @map("current_version_id") @db.Uuid
  isActive         Boolean  @default(true) @map("is_active")
  createdBy        String   @map("created_by") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  versions       TemplateVersion[] @relation("TemplateVersions")
  currentVersion TemplateVersion?  @relation("CurrentTemplateVersion", fields: [currentVersionId], references: [id])
  contracts      Contract[]        @relation("TemplateContracts")

  @@map("document_templates")
}

// Template Versions - Immutable once published
enum TemplateVersionStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model TemplateVersion {
  id                  String                @id @default(uuid()) @db.Uuid
  templateId          String                @map("template_id") @db.Uuid
  version             Int                   @map("version")
  status              TemplateVersionStatus @default(DRAFT) @map("status")
  locale              String                @default("en-CA") @map("locale") @db.VarChar(10)
  bodyHtml            String                @map("body_html") @db.Text
  variablesSchema     Json                  @map("variables_schema")
  defaultData         Json                  @default("{}") @map("default_data")
  changeNotes         String?               @map("change_notes") @db.Text
  previewPdfS3Key     String?               @map("preview_pdf_s3_key") @db.VarChar(500)
  checksumSha256      String                @map("checksum_sha256") @db.VarChar(64)
  googleDocTemplateId String?               @map("google_doc_template_id") @db.VarChar(255)
  googleDocFolderId   String?               @map("google_doc_folder_id") @db.VarChar(255)
  createdBy           String                @map("created_by") @db.Uuid
  createdAt           DateTime              @default(now()) @map("created_at") @db.Timestamptz()

  template        DocumentTemplate  @relation("TemplateVersions", fields: [templateId], references: [id], onDelete: Cascade)
  contracts       Contract[]        @relation("VersionContracts")
  currentTemplate DocumentTemplate? @relation("CurrentTemplateVersion")

  @@unique([templateId, version])
  @@index([templateId])
  @@index([googleDocTemplateId])
  @@map("template_versions")
}

// Contract Instances - Immutable after 'sent'
enum ContractStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  PENDING_SIGNATURE
}

model Contract {
  id                   String         @id @default(uuid()) @db.Uuid
  examinerProfileId    String         @map("examiner_profile_id") @db.Uuid
  templateId           String         @map("template_id") @db.Uuid
  templateVersionId    String         @map("template_version_id") @db.Uuid
  status               ContractStatus @default(DRAFT) @map("status")
  data                 Json           @map("data")
  dataHash             String         @map("data_hash") @db.VarChar(64)
  unsignedPdfS3Key     String?        @map("unsigned_pdf_s3_key") @db.VarChar(500)
  unsignedPdfSha256    String?        @map("unsigned_pdf_sha256") @db.VarChar(64)
  signedPdfS3Key       String?        @map("signed_pdf_s3_key") @db.VarChar(500)
  signedPdfSha256      String?        @map("signed_pdf_sha256") @db.VarChar(64)
  googleDocId          String?        @map("google_doc_id") @db.VarChar(500)
  googleDocUrl         String?        @map("google_doc_url") @db.Text
  drivePdfId           String?        @map("drive_pdf_id") @db.VarChar(500)
  sentAt               DateTime?      @map("sent_at") @db.Timestamptz()
  viewedAt             DateTime?      @map("viewed_at") @db.Timestamptz()
  signedAt             DateTime?      @map("signed_at") @db.Timestamptz()
  declinedAt           DateTime?      @map("declined_at") @db.Timestamptz()
  voidReason           String?        @map("void_reason") @db.Text
  accessToken          String?        @map("access_token") @db.Text
  accessTokenExpiresAt DateTime?      @map("access_token_expires_at") @db.Timestamptz()
  signedByExaminer     Boolean        @default(false) @map("signed_by_examiner")
  createdBy            String         @map("created_by") @db.Uuid
  createdAt            DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt            DateTime       @updatedAt @map("updated_at") @db.Timestamptz()

  examinerProfile ExaminerProfile  @relation("ExaminerContracts", fields: [examinerProfileId], references: [id], onDelete: Cascade)
  template        DocumentTemplate @relation("TemplateContracts", fields: [templateId], references: [id])
  templateVersion TemplateVersion  @relation("VersionContracts", fields: [templateVersionId], references: [id])
  events          ContractEvent[]  @relation("ContractEvents")

  @@index([examinerProfileId])
  @@index([status])
  @@index([templateId])
  @@index([googleDocId])
  @@map("contracts")
}

// Contract Events - Full audit trail
model ContractEvent {
  id         String   @id @default(uuid()) @db.Uuid
  contractId String   @map("contract_id") @db.Uuid
  eventType  String   @map("event_type") @db.VarChar(50)
  actorRole  String?  @map("actor_role") @db.VarChar(50)
  actorId    String?  @map("actor_id") @db.Uuid
  at         DateTime @default(now()) @map("at") @db.Timestamptz()
  meta       Json     @default("{}") @map("meta")

  contract Contract @relation("ContractEvents", fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([eventType])
  @@map("contract_events")
}
