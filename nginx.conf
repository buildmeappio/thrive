# upgrade helper (WebSockets, SSE)
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# HTTP â†’ HTTPS redirect
server {
    if ($host = portal-dev.thriveassessmentcare.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


  listen 80;
  server_name portal-dev.thriveassessmentcare.com;
  return 301 https://$host$request_uri;


}

# HTTPS
server {
  listen 443 ssl http2;
  server_name portal-dev.thriveassessmentcare.com;

  # certbot will fill these
    ssl_certificate /etc/letsencrypt/live/portal-dev.thriveassessmentcare.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/portal-dev.thriveassessmentcare.com/privkey.pem; # managed by Certbot

  # security + perf
  client_max_body_size 25m;
  sendfile on;
  gzip on;
  gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;
  gzip_min_length 1024;

  # optional HSTS (enable after verifying HTTPS works)
  # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;


  # Admin Running on port 3000

  # enforce /admin/ with trailing slash
  location = /admin { return 301 /admin/; }

  # proxy all admin traffic AS-IS (Next.js basePath=/admin)
  location /admin/ {
    proxy_pass http://127.0.0.1:3000;   # no trailing slash
    proxy_http_version 1.1;

    proxy_set_header Host                $host;
    proxy_set_header X-Real-IP           $remote_addr;
    proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto   $scheme;
    proxy_set_header Upgrade             $http_upgrade;
    proxy_set_header Connection          $connection_upgrade;

    # CRITICAL: Increase buffer sizes for Next.js Server Actions
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_buffers 16 32k;
    proxy_buffer_size 64k;

    # Increase timeouts for server actions
    proxy_connect_timeout 60s;
    proxy_send_timeout    120s;
    proxy_read_timeout    120s;

    # Allow large POST bodies (for file uploads)
    client_body_buffer_size 10M;
  }

  # cache immutable Next.js assets
  location ^~ /admin/_next/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    expires 7d;
    access_log off;
  }

  # common files
  location = /admin/robots.txt   { proxy_pass http://127.0.0.1:3000; }
  location = /admin/sitemap.xml  { proxy_pass http://127.0.0.1:3000; }
  location = /admin/favicon.ico  { proxy_pass http://127.0.0.1:3000; }



  # Examiner Running on port 3001

  # enforce /examiner/ with trailing slash
  location = /examiner { return 301 /examiner/; }

  # proxy all examiner traffic AS-IS (Next.js basePath=/examiner)
  location /examiner/ {
    proxy_pass http://127.0.0.1:3001;   # no trailing slash
    proxy_http_version 1.1;

    proxy_set_header Host                $host;
    proxy_set_header X-Real-IP           $remote_addr;
    proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto   $scheme;
    proxy_set_header Upgrade             $http_upgrade;
    proxy_set_header Connection          $connection_upgrade;

    # CRITICAL: Increase buffer sizes for Next.js Server Actions
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_buffers 16 32k;
    proxy_buffer_size 64k;

    # Increase timeouts for server actions
    proxy_connect_timeout 60s;
    proxy_send_timeout    120s;
    proxy_read_timeout    120s;

    # Allow large POST bodies (for file uploads)
    client_body_buffer_size 10M;
  }

  # cache immutable Next.js assets
  location ^~ /examiner/_next/ {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    expires 7d;
    access_log off;
  }

  # common files
  location = /examiner/robots.txt   { proxy_pass http://127.0.0.1:3001; }
  location = /examiner/sitemap.xml  { proxy_pass http://127.0.0.1:3001; }
  location = /examiner/favicon.ico  { proxy_pass http://127.0.0.1:3001; }

  # everything else closed
  location / { return 404; }

}