name: Deploy Database Migrations

on:
  push:
    branches:
      - main      # Deploy to production
      - staging   # Deploy to staging
      - qa        # Deploy to QA
      - develop   # Deploy to dev

  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
      run_seeders:
        description: 'Run seeders after migrations?'
        required: true
        type: boolean
        default: true

permissions:
  contents: read    # Required to checkout code

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      run_seeders: ${{ steps.set-env.outputs.run_seeders }}
    steps:
      - name: Set Environment
        id: set-env
        run: |
          # Check if this is a manual workflow_dispatch run
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "run_seeders=${{ inputs.run_seeders }}" >> $GITHUB_OUTPUT
          else
            # Automatic runs based on branch
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "environment=prod" >> $GITHUB_OUTPUT
              echo "run_seeders=false" >> $GITHUB_OUTPUT  # Never auto-run in prod
            elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "run_seeders=true" >> $GITHUB_OUTPUT
            elif [[ "${{ github.ref }}" == "refs/heads/qa" ]]; then
              echo "environment=qa" >> $GITHUB_OUTPUT
              echo "run_seeders=true" >> $GITHUB_OUTPUT
            elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
              echo "environment=develop" >> $GITHUB_OUTPUT
              echo "run_seeders=true" >> $GITHUB_OUTPUT
            else
              echo "environment=develop" >> $GITHUB_OUTPUT
              echo "run_seeders=true" >> $GITHUB_OUTPUT
            fi
          fi


  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [determine-environment]
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - name: Create .env file on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER || 'ec2-user' }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            bash -l -c "
            cd ${{ secrets.APP_DIR }}
            # Remove existing .env file
            if [ -f .env ]; then
              rm .env
            fi
            # Create new .env file
            echo 'DATABASE_URL=${{ secrets.DATABASE_URL }}' > .env
            echo 'âœ… Created .env file with DATABASE_URL'
            "

      - name: Run Migrations on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER || 'ec2-user' }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            bash -l -c "
            cd ${{ secrets.APP_DIR }}
            echo 'ğŸ“¦ Current directory: \$(pwd)'
            echo 'ğŸ” Checking Node.js installation...'
            which node || echo 'âš ï¸  Node.js not found in PATH'
            which npm || echo 'âš ï¸  npm not found in PATH'
            which npx || echo 'âš ï¸  npx not found in PATH'
            
            echo 'ğŸ” Checking Prisma installation...'
            
            if [ ! -d 'node_modules' ]; then
              echo 'ğŸ“¥ Installing dependencies...'
              npm install
            fi
            
            echo 'ğŸ”„ Running Prisma migrations...'
            npx prisma migrate deploy
            
            echo 'âœ… Migrations completed successfully!'
            "

  run-seeders:
    name: Run Database Seeders
    runs-on: ubuntu-latest
    needs: [determine-environment, run-migrations]
    # Run seeders based on environment logic:
    # - Dev/QA/Staging: Auto-run (idempotent, safe)
    # - Production: Only via manual workflow_dispatch
    if: needs.determine-environment.outputs.run_seeders == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - name: Run Seeders on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER || 'ec2-user' }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            bash -l -c "
            cd ${{ secrets.APP_DIR }}
            echo 'ğŸ“¦ Current directory: \$(pwd)'
            echo 'ğŸ” Checking Node.js installation...'
            which node || echo 'âš ï¸  Node.js not found in PATH'
            which npm || echo 'âš ï¸  npm not found in PATH'
            
            echo 'ğŸ” Checking Prisma installation...'
            
            if [ ! -d 'node_modules' ]; then
              echo 'ğŸ“¥ Installing dependencies...'
              npm install
            fi
            
            echo 'ğŸŒ± Running Prisma seeders...'
            npm run seed
            
            echo 'âœ… Seeders completed successfully!'
            "

