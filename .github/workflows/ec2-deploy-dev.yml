name: Ec2 Deploy (develop)

on:
  push:
    branches: [develop]
  workflow_dispatch: {}   # manual runs also go to dev

concurrency:
  group: deploy-develop
  cancel-in-progress: false

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION || '22' }}
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run build

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    environment: dev   # <- always dev
    steps:
      - name: Add EC2 host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            APP_DIR="${{ vars.APP_DIR || '/opt/myapp' }}"
            cd "$APP_DIR"

            git fetch --prune origin
            git checkout develop || git switch -c develop
            git reset --hard origin/develop

            if [ -s "$HOME/.nvm/nvm.sh" ]; then . "$HOME/.nvm/nvm.sh"; fi

            npm run deploy:dev
