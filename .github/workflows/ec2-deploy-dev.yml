name: Ec2 Deploy (develop)

on:
  push:
    branches: [develop]
  workflow_dispatch: {} # manual runs also go to dev
  pull_request:
    branches: [develop]

concurrency:
  group: deploy-develop
  cancel-in-progress: false

jobs:
  ci:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION || '22' }}
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run build

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: dev # <- always dev
    steps:
      - name: Add EC2 host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          envs: |
            ENVIRONMENT,APP_DIR,DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GMAIL_USER,GMAIL_REFRESH_TOKEN,NEXT_PUBLIC_APP_URL
          script: |
            set -euo pipefail
            APP_DIR="${{ vars.APP_DIR || '/opt/myapp' }}"
            cd "$APP_DIR"

            # Create .env file
            umask 077
            tmpfile="$(mktemp)"
            cat > "$tmpfile" <<EOF
            ENVIRONMENT=${ENVIRONMENT}
            DATABASE_URL=${DATABASE_URL}
            NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
            NEXTAUTH_URL=${NEXTAUTH_URL}
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            GMAIL_USER=${GMAIL_USER}
            GMAIL_REFRESH_TOKEN=${GMAIL_REFRESH_TOKEN}
            NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
            EOF
            mv "$tmpfile" .env

            git fetch --prune origin
            git checkout develop || git switch -c develop
            git reset --hard origin/develop

            if [ -s "$HOME/.nvm/nvm.sh" ]; then . "$HOME/.nvm/nvm.sh"; fi

            npm run deploy:dev
          env:
            ENVIRONMENT: ${{ vars.ENVIRONMENT || 'development' }}
            APP_DIR: ${{ vars.APP_DIR || '/opt/myapp' }}
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
            GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
            GMAIL_USER: ${{ secrets.GMAIL_USER }}
            GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
            NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
