name: Deploy to Dev

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]
  workflow_dispatch:

concurrency:
  group: deploy-dev-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write
  actions: write

jobs:
  ci:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Check linting
        run: npm run lint:check

      - name: Format code
        run: npm run format:check

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create .env file from AWS Secrets Manager
        run: |
          # Install jq if not available
          sudo apt-get update && sudo apt-get install -y jq || true

          # Fetch secrets from AWS Secrets Manager
          SHARED_SECRET=$(aws secretsmanager get-secret-value --secret-id dev/shared --region ${{ secrets.AWS_REGION }} --query SecretString --output text)
          ADMIN_SECRET=$(aws secretsmanager get-secret-value --secret-id dev/admin --region ${{ secrets.AWS_REGION }} --query SecretString --output text)

          # Merge secrets (admin overrides shared) and convert JSON to .env format
          jq -r -n --argjson shared "$SHARED_SECRET" --argjson admin "$ADMIN_SECRET" '$shared * $admin | to_entries[] | "\(.key)=\(.value | tojson)"' > .env

      - name: Check build
        run: |
          npm run db:generate
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: github.event_name != 'pull_request'
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            prisma/
            package.json
            package-lock.json
            next.config.ts
            tailwind.config.ts
            postcss.config.mjs
            ecosystem.config.js
            scripts/
            templates/
            tsconfig.json
            prisma.config.ts
          retention-days: 1
  deploy:
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name != 'pull_request'
    environment: dev
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Create deployment package
        run: |
          cd artifacts
          tar -czf ../deployment.tar.gz .
          cd ..

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: "deployment.tar.gz"
          target: "${{ secrets.EC2_DEPLOY_PATH }}/"

      - name: Run deployment script on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # Set deployment path and variables
            DEPLOY_PATH="${{ secrets.EC2_DEPLOY_PATH }}"
            AWS_REGION="${{ secrets.AWS_REGION }}"
            APP_NAME="thrive-admin"

            # Load nvm and use Node.js version 22
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22 || nvm install 22 && nvm use 22

            # Create directory if it doesn't exist
            mkdir -p $DEPLOY_PATH

            # Change to the deployment directory
            cd $DEPLOY_PATH

            # Extract deployment package
            echo "ðŸ“¦ Extracting deployment artifacts..."
            if [ -f deployment.tar.gz ]; then
              tar -xzf deployment.tar.gz
              rm -f deployment.tar.gz
              echo "âœ… Artifacts extracted successfully"
            else
              echo "âš ï¸ deployment.tar.gz not found, continuing with existing files"
            fi

            # Install jq if not available
            sudo apt-get update && sudo apt-get install -y jq || true

            # Fetch secrets from AWS Secrets Manager
            SHARED_SECRET=$(aws secretsmanager get-secret-value --secret-id dev/shared --region $AWS_REGION --query SecretString --output text)
            ADMIN_SECRET=$(aws secretsmanager get-secret-value --secret-id dev/admin --region $AWS_REGION --query SecretString --output text)

            # Merge secrets (admin overrides shared) and convert JSON to .env format
            jq -r -n --argjson shared "$SHARED_SECRET" --argjson admin "$ADMIN_SECRET" '$shared * $admin | to_entries[] | "\(.key)=\(.value | tojson)"' > .env

            # Install production dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps --include=optional

            # Generate Prisma client
            echo "ðŸ”§ Generating Prisma client..."
            npm run db:generate

            # Make deploy script executable
            chmod +x scripts/deploy.sh || true

            # Run deployment script with skip-build flag
            echo "ðŸš€ Running deployment script..."
            ./scripts/deploy.sh dev --app $APP_NAME --config ecosystem.config.js --env .env --skip-build || {
              # Fallback: Manual PM2 deployment if script fails
              echo "âš ï¸ Deploy script failed, using manual PM2 deployment..."
              
              # Stop existing PM2 process if running
              if pm2 describe "$APP_NAME" > /dev/null 2>&1; then
                echo "ðŸ›‘ Stopping existing PM2 process..."
                pm2 stop "$APP_NAME"
                pm2 delete "$APP_NAME"
              fi

              # Start with PM2
              echo "ðŸš€ Starting PM2..."
              pm2 start ecosystem.config.js --name "$APP_NAME"
              pm2 save
            }

            # Show PM2 status
            echo "ðŸ“Š PM2 Status:"
            pm2 list
            pm2 describe "$APP_NAME" || true
