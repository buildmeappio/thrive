name: EC2 Deploy

on:
  push:
    branches: [develop, staging, qa, main]
  pull_request:
    branches: [develop, staging, qa, main]
  workflow_dispatch: {}

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

# Helper: branch→environment
# main→prod, develop→dev, others 1:1
env:
  TARGET_ENV: ${{ github.ref_name == 'main' && 'prod' || github.ref_name == 'develop' && 'dev' || github.ref_name }}

jobs:
  ci:
    runs-on: ubuntu-latest
    environment: ${{ env.TARGET_ENV }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION || '22' }}
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run build

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: ${{ env.TARGET_ENV }}
    steps:
      - name: Add EC2 host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          envs: |
            ENVIRONMENT,APP_DIR,BRANCH,DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GMAIL_USER,GMAIL_REFRESH_TOKEN,NEXT_PUBLIC_APP_URL
          script: |
            set -euo pipefail
            cd "$APP_DIR"

            umask 077
            tmpfile="$(mktemp)"
            printf 'ENVIRONMENT=%s\n'           "$ENVIRONMENT"           >> "$tmpfile"
            printf 'DATABASE_URL=%s\n'          "$DATABASE_URL"          >> "$tmpfile"
            printf 'NEXTAUTH_SECRET=%s\n'       "$NEXTAUTH_SECRET"       >> "$tmpfile"
            printf 'NEXTAUTH_URL=%s\n'          "$NEXTAUTH_URL"          >> "$tmpfile"
            printf 'GOOGLE_CLIENT_ID=%s\n'      "$GOOGLE_CLIENT_ID"      >> "$tmpfile"
            printf 'GOOGLE_CLIENT_SECRET=%s\n'  "$GOOGLE_CLIENT_SECRET"  >> "$tmpfile"
            printf 'GMAIL_USER=%s\n'            "$GMAIL_USER"            >> "$tmpfile"
            printf 'GMAIL_REFRESH_TOKEN=%s\n'   "$GMAIL_REFRESH_TOKEN"   >> "$tmpfile"
            printf 'NEXT_PUBLIC_APP_URL=%s\n'   "$NEXT_PUBLIC_APP_URL"   >> "$tmpfile"
            mv "$tmpfile" .env

            git fetch --prune origin
            git checkout "$BRANCH" || git switch -c "$BRANCH"
            git reset --hard "origin/$BRANCH"

            [ -s "$HOME/.nvm/nvm.sh" ] && . "$HOME/.nvm/nvm.sh"
            npm run deploy:${ENVIRONMENT}
        env:
          # Derived
          ENVIRONMENT: ${{ env.TARGET_ENV }}                  # dev | staging | qa | prod
          BRANCH:      ${{ github.ref_name }}                 # develop | staging | qa | main

          # Per-environment secrets/vars (set under repo Settings → Environments)
          APP_DIR:              ${{ vars.APP_DIR || '/opt/myapp' }}
          DATABASE_URL:         ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET:      ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL:         ${{ secrets.NEXTAUTH_URL }}
          GOOGLE_CLIENT_ID:     ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GMAIL_USER:           ${{ secrets.GMAIL_USER }}
          GMAIL_REFRESH_TOKEN:  ${{ secrets.GMAIL_REFRESH_TOKEN }}
          NEXT_PUBLIC_APP_URL:  ${{ secrets.NEXT_PUBLIC_APP_URL }}
